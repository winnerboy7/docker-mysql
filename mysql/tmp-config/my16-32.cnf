# =============================================================================
# MySQL Configuration File for MySQL 8.x
# Optimized for a system with 32GB RAM and 16 CPU Cores
# Workload: General Purpose / OLTP (InnoDB-focused)

# Warnings:
# 1. This is an "Aggressive Start" configuration focused on performance.
# 2. Test on a Staging Server before deploying to Production.
# 3. Backup your original my.cnf file before making changes.
# 4. Typical file locations: /etc/mysql/my.cnf or /etc/my.cnf
# 5. Further tuning may be required based on your specific workload and hardware.

# Configured by Chaimongkol Khamkom (ToMDev)
# FB: https://facebook.com/winnerboy7
# Email: winnerboy7-At-gmail-Dot-com
# =============================================================================

[mysqld]

# --- General Server Settings ---
user                                = mysql
default-storage-engine              = InnoDB
character-set-server                = utf8mb4
collation-server                    = utf8mb4_unicode_ci

bind-address                        = 0.0.0.0
port                                = 3306

# Position of files (may need adjustment based on your OS)
basedir                             = /usr
datadir                             = /var/lib/mysql
socket                              = /var/run/mysqld/mysqld.sock
pid-file                            = /var/run/mysqld/mysqld.pid

# SQL Mode Settings
# sql_mode                            = ""
# sql-mode                            = "STRICT_TRANS_TABLES,NO_ENGINE_SUBSTITUTION"

# --- Network & Connection Handling ---
# 16 Cores For a system with high connection demands
max_connections                     = 512
max_allowed_packet                  = 256M

# --- Table & Thread Caches (for 16 Cores) ---
# Keep threads ready to respond = 2 times the number of Cores
thread_cache_size                   = 32
table_open_cache                    = 4096
table_definition_cache              = 2048
open_files_limit                    = 65535

# --- In-Memory Tables ---
# Use more RAM for temp tables to avoid disk writes
tmp_table_size                      = 256M
max_heap_table_size                 = 256M

# --- InnoDB Settings (the most important part) ---
# ** Core Principle: Use 70% of RAM (about 22GB) for Buffer Pool **
# Buffer Pool holds both Data and Indexes in RAM
innodb_buffer_pool_size             = 22G

# Divide Buffer Pool into 16 parts (equal to number of Cores) to reduce contention
innodb_buffer_pool_instances        = 16

# Save and load Buffer Pool state for faster restarts
innodb_buffer_pool_dump_at_shutdown = 1
innodb_buffer_pool_load_at_startup  = 1

# --- InnoDB I/O Settings (for Cloud/SSD) ---
# Configure InnoDB to recognize that we are using fast disks (SSD/NVMe)
innodb_io_capacity                  = 2000
innodb_io_capacity_max              = 4000
innodb_flush_method                 = O_DIRECT

# Enhance I/O threads for better performance (default 4)
innodb_read_io_threads              = 8
innodb_write_io_threads             = 8

# Let InnoDB manage concurrency automatically (best for 8.x)
innodb_thread_concurrency           = 0

# --- Log Settings ---
# Set log sizes for better performance
# Use redo logs of 2GB each to balance performance and recovery time
innodb_log_file_size                = 1G
innodb_log_files_in_group           = 2

# Set flush at transaction commit to 2 for better performance with some durability trade-off
# Set to 1 for full ACID compliance
# Set to 2 to reduce disk I/O at the cost of potential data loss in a crash
# OS does not crash frequently, so 2 is often acceptable
innodb_flush_log_at_trx_commit      = 2

# --- File & Caches ---
innodb_file_per_table               = 1
innodb_lru_scan_depth               = 256

# --- Logging ---
log_error                           = /var/log/mysql/error.log
log_error_verbosity                 = 2

# --- Slow Query Log ---
slow_query_log                      = 1
slow_query_log_file                 = /var/log/mysql/slow-query.log

# Log queries that take longer than 1 second
long_query_time                     = 1

# Log queries that do not use indexes
log_queries_not_using_indexes       = 1

# --- Binary Log ---
server-id                           = 1
log_bin                             = /var/log/mysql/mysql-bin.log
binlog_format                       = ROW
binlog_expire_logs_seconds          = 604800  # 7 days
sync_binlog                         = 1       # Ensure binary log integrity

# --- MySQL 8.4 Settings ---
# Query Cache is removed in MySQL 8.0 and later
# innodb_redo_log_capacity is new in MySQL 8.4 for better redo log management
default_authentication_plugin       = caching_sha2_password

# --- Optional Settings (Uncomment if needed) ---
# # General Query Log (for debugging, disable in production)
# general_log = 1
# general_log_file = /var/lib/mysql/general.log

#--- MySQL 8.x Configuration for 32GB RAM System ---
# InnoDB Settings (Crucial for Performance)
# # Adjust based on your workload and hardware
# # Connection and Thread variables

# innodb_read_io_threads = 8          # Adjust based on I/O workload and storage speed
# innodb_write_io_threads = 8         # Adjust based on I/O workload and storage speed
# innodb_thread_concurrency = 0       # Let InnoDB manage concurrency automatically
# innodb_buffer_pool_instances = 16   # Recommended for large buffer pools on multi-core systems
# innodb_buffer_pool_size = 16G       # Adjust 70% of 32GB is 22G
# innodb_log_file_size = 2G           # Or larger, e.g., 2G, ensure it's a power of 2
# innodb_log_buffer_size = 64M
# innodb_file_per_table = 1           # Recommended for better management and space reclamation
# innodb_log_files_in_group = 2
# innodb_flush_log_at_trx_commit = 2  # 1 for durability, 2 for slightly better performance (less durable)
# innodb_flush_method = O_DIRECT      # Recommended for Linux systems
# innodb_io_capacity = 2000           # Adjust based on your disk's IOPS
# innodb_io_capacity_max = 4000       # Adjust based on your disk's IOPS
# key_buffer_size = 256M              # For MyISAM tables, if used